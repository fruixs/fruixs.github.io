<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>concurrency problem</title>
    <link rel="stylesheet" href="reset.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- ë™ì‹œì„± ë¬¸ì œ í•´ê²° ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ -->
    <div class="container">
        <div class="contents">
            <div class="havbutton">
                <div class="top">
                    <button type="button">ë¼ë©´ì¶”ê°€</button>
                </div>
                <div class="middle">
                    <p class="description">ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¹„ë™ê¸° ì²˜ë¦¬ì˜ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë¼ë©´ì§‘ì…ë‹ˆë‹¤.</p>
                </div>
                <div class="bottom">
                    <span class="description">ì ‘ìˆ˜&nbsp;</span>
                    <span id="number-person" class="description">0</span>
                    <span class="description">ë²ˆ</span>
                    <br>
                    <span class="description">ëŒ€ê¸°&nbsp;</span>
                    <span id="number-delay-person" class="description">0</span>
                    <span class="description">ëª…</span>
                    <br>
                    <span class="description">ì™„ë£Œ&nbsp;</span>
                    <span id="number-ok-person" class="description">0</span>
                    <span class="description">ëª…</span>
                </div>
            </div>
            <div class="status">
                <!-- <p>ğŸœ</p> -->
                <!-- <p>âœ…</p> -->
                <!-- <p>â™¨</p> -->
                <!-- <p>ğŸœ</p> -->
            </div>
        </div>
    </div>
    <script>
        window.addEventListener("load", function () {
            let ramenObject = {
                statusDiv: document.querySelector(".container>.contents .status"),
                nodePerson: document.getElementById("number-person"),
                nodeDelayPerson: document.getElementById("number-delay-person"),
                nodeOkPerson: document.getElementById("number-ok-person"),
                numberPerson: 0,
                numberOkPerson: 0,
                numberDelayPerson: 0,
                arrayDelayPerson: [],
                button: document.querySelector(".container>.contents button"),
                ramenCounter: 1,
                isLock: false,
                init() {
                    this.addMessageRamen = this.addMessageRamen.bind(this);
                    // this.ramenP = this.ramenP.bind(this);
                },
                ramenP() {
                    // ì ê¸ˆí•´ì œ
                    this.isLock = false;
                    // console.log("ramenP ì˜ this ", this)
                    
                    let pNode = document.createElement("p");
                    pNode.append(document.createTextNode(`ğŸœ ${this.ramenCounter}ë²ˆì§¸ ì†ë‹˜ ì£¼ë¬¸ ì™„ë£Œ`))
                    this.statusDiv.append(pNode);
                    this.nodePerson.innerText = this.ramenCounter++;
                    this.nodeDelayPerson.innerText = --this.numberDelayPerson;
                    this.nodeOkPerson.innerText = ++this.numberOkPerson;
                    if(this.arrayDelayPerson.length > 0) {
                        this.arrayDelayPerson.shift()();
                        this.nodeDelayPerson.innerText = --this.numberDelayPerson;
                    } else {
                        this.numberDelayPerson = 0;
                    }
                },

                addMessageRamen() {
                    /* arguments.callee ì´ìš©í•˜ì—¬ në²ˆì§¸ ì£¼ë¬¸ì— (n+1)ë²ˆì§¸ ì£¼ë¬¸ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” ì˜¤ë¥˜ë°©ì§€ í•„ìš” */
                    if (!this.isLock) {
                        this.isLock = true;
                        let pNode = document.createElement("p");
                        let textNode = document.createTextNode(`âœ… ${this.ramenCounter}ë²ˆì§¸ ì†ë‹˜ ì£¼ë¬¸ í™•ì¸`);
                        pNode.append(textNode);
                        this.statusDiv.append(pNode);
                        console.log("addMessageRamen ì˜ this", this)

                        this.nodePerson.innerText = this.ramenCounter;
                        this.nodeDelayPerson.innerText = ++this.numberDelayPerson;
                        // Arrow function ì— ì˜í•´ ramenP ëŠ” lexical ë¡œ addMessageRamen scope ì˜ thisë¥¼ ë°”ì¸ë”©í•œë‹¤.
                        setTimeout(() => this.ramenP(), 2000)
                        console.log(this.nodePerson.childNodes.length);
                    } else {
                        /* isLock = true ê°€ ë˜ì–´ ëŒ€ê¸°í•˜ëŠ” ì¸ì› */
                        /* 
                        arguments.callee ê°€ Eventlistener ì—ì„œ ê±´ë‚¸ this ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´
                        arguments.callee.bind ë¡œ ì„ì˜ ì§€ì •í•œ this ê°–ëŠ” í•¨ìˆ˜ë¥¼ ë°°ì—´ì— ë„£ìŒ
                        */
                        this.numberDelayPerson++
                        this.nodeDelayPerson.innerText = this.numberDelayPerson;
                        this.arrayDelayPerson.push(arguments.callee.bind(this))
                    }
                }
            }
            ramenObject.init();
            ramenObject.button.addEventListener("click", ramenObject.addMessageRamen)
        })
    </script>
</body>

</html>